# æ•°æ®é€è§†ä¸åˆå¹¶ - å®Œæ•´ç­”æ¡ˆ
# ä½œè€…ï¼šAIåŠ©æ‰‹
# è¯´æ˜ï¼šè¿™æ˜¯å¯¹æ•°æ®é€è§†ä¸åˆå¹¶notebookä¸­æ‰€æœ‰ç»ƒä¹ é¢˜çš„å®Œæ•´è§£ç­”

import pandas as pd
import numpy as np

print("=== æ•°æ®é€è§†ä¸åˆå¹¶ç»ƒä¹ é¢˜å®Œæ•´ç­”æ¡ˆ ===\n")

# 1 - åŠ è½½æ•°æ®
print("1. åŠ è½½æ•°æ®")
print("ä»£ç : df = pd.read_csv('æŸè¶…å¸‚é”€å”®æ•°æ®.csv', thousands=',')")

try:
    df = pd.read_csv("æŸè¶…å¸‚é”€å”®æ•°æ®.csv", thousands=',')
    print("âœ… æ•°æ®åŠ è½½æˆåŠŸï¼")
    print(f"æ•°æ®å½¢çŠ¶: {df.shape}")
    print(f"åˆ—å: {list(df.columns)}")
    print("\næ•°æ®å‰5è¡Œ:")
    print(df.head())
    print("\n" + "="*60 + "\n")
except FileNotFoundError:
    print("âŒ æ‰¾ä¸åˆ°æ•°æ®æ–‡ä»¶ï¼Œè¯·ç¡®ä¿ 'æŸè¶…å¸‚é”€å”®æ•°æ®.csv' åœ¨å½“å‰ç›®å½•")
    exit()

# 2 - æ•°æ®é€è§†ï½œé»˜è®¤ - åˆ¶ä½œå„çœã€Œå¹³å‡é”€å”®é¢ã€çš„æ•°æ®é€è§†è¡¨
print("2. æ•°æ®é€è§†ï½œé»˜è®¤ - å„çœå¹³å‡é”€å”®é¢")
print("ä»£ç : df.pivot_table(values='é”€å”®é¢', index='çœ/è‡ªæ²»åŒº')")

pivot_2 = df.pivot_table(values='é”€å”®é¢', index='çœ/è‡ªæ²»åŒº')
print("å„çœå¹³å‡é”€å”®é¢:")
print(pivot_2.round(2))
print("\n" + "-"*50 + "\n")

# 3 - æ•°æ®é€è§†ï½œæŒ‡å®šæ–¹æ³• - åˆ¶ä½œå„çœã€Œé”€å”®æ€»é¢ã€çš„æ•°æ®é€è§†è¡¨
print("3. æ•°æ®é€è§†ï½œæŒ‡å®šæ–¹æ³• - å„çœé”€å”®æ€»é¢")
print("ä»£ç : df.pivot_table(values='é”€å”®é¢', index='çœ/è‡ªæ²»åŒº', aggfunc='sum')")

pivot_3 = df.pivot_table(values='é”€å”®é¢', index='çœ/è‡ªæ²»åŒº', aggfunc='sum')
print("å„çœé”€å”®æ€»é¢:")
print(pivot_3.round(2))
print("\n" + "-"*50 + "\n")

# 4 - æ•°æ®é€è§†ï½œå¤šæ–¹æ³• - åˆ¶ä½œå„çœã€Œé”€å”®æ€»é¢ã€ä¸ã€Œå¹³å‡é”€å”®é¢ã€çš„æ•°æ®é€è§†è¡¨
print("4. æ•°æ®é€è§†ï½œå¤šæ–¹æ³• - å„çœé”€å”®æ€»é¢ä¸å¹³å‡é”€å”®é¢")
print("ä»£ç : df.pivot_table(values='é”€å”®é¢', index='çœ/è‡ªæ²»åŒº', aggfunc=['sum', 'mean'])")

pivot_4 = df.pivot_table(values='é”€å”®é¢', index='çœ/è‡ªæ²»åŒº', aggfunc=['sum', 'mean'])
print("å„çœé”€å”®æ€»é¢ä¸å¹³å‡é”€å”®é¢:")
print(pivot_4.round(2))
print("\n" + "-"*50 + "\n")

# 5 - æ•°æ®é€è§†ï½œå¤šæŒ‡æ ‡ - åˆ¶ä½œå„çœå¸‚ã€Œé”€å”®æ€»é¢ã€ä¸ã€Œåˆ©æ¶¦æ€»é¢ã€çš„æ•°æ®é€è§†è¡¨
print("5. æ•°æ®é€è§†ï½œå¤šæŒ‡æ ‡ - å„çœé”€å”®æ€»é¢ä¸åˆ©æ¶¦æ€»é¢")
print("ä»£ç : df.pivot_table(values=['é”€å”®é¢', 'åˆ©æ¶¦'], index='çœ/è‡ªæ²»åŒº', aggfunc='sum')")

pivot_5 = df.pivot_table(values=['é”€å”®é¢', 'åˆ©æ¶¦'], index='çœ/è‡ªæ²»åŒº', aggfunc='sum')
print("å„çœé”€å”®æ€»é¢ä¸åˆ©æ¶¦æ€»é¢:")
print(pivot_5.round(2))
print("\n" + "-"*50 + "\n")

# 6 - æ•°æ®é€è§†ï½œå¤šç´¢å¼• - åˆ¶ä½œã€Œå„çœå¸‚ã€ä¸ã€Œä¸åŒç±»åˆ«ã€äº§å“ã€Œé”€å”®æ€»é¢ã€çš„æ•°æ®é€è§†è¡¨
print("6. æ•°æ®é€è§†ï½œå¤šç´¢å¼• - å„çœå¸‚ä¸ä¸åŒç±»åˆ«äº§å“é”€å”®æ€»é¢")
print("ä»£ç : df.pivot_table(values='é”€å”®é¢', index=['çœ/è‡ªæ²»åŒº', 'ç±»åˆ«'], aggfunc='sum')")

pivot_6 = df.pivot_table(values='é”€å”®é¢', index=['çœ/è‡ªæ²»åŒº', 'ç±»åˆ«'], aggfunc='sum')
print("å„çœå¸‚ä¸ä¸åŒç±»åˆ«äº§å“é”€å”®æ€»é¢:")
print(pivot_6.round(2))
print("\n" + "-"*50 + "\n")

# 7 - æ•°æ®é€è§†ï½œå¤šå±‚ - åˆ¶ä½œå„çœå¸‚ã€Œä¸åŒç±»åˆ«ã€äº§å“çš„ã€Œé”€å”®æ€»é¢ã€é€è§†è¡¨
print("7. æ•°æ®é€è§†ï½œå¤šå±‚ - å„çœå¸‚ä¸åŒç±»åˆ«äº§å“é”€å”®æ€»é¢ï¼ˆåˆ—é€è§†ï¼‰")
print("ä»£ç : df.pivot_table(values='é”€å”®é¢', index='çœ/è‡ªæ²»åŒº', columns='ç±»åˆ«', aggfunc='sum')")

pivot_7 = df.pivot_table(values='é”€å”®é¢', index='çœ/è‡ªæ²»åŒº', columns='ç±»åˆ«', aggfunc='sum')
print("å„çœå¸‚ä¸åŒç±»åˆ«äº§å“é”€å”®æ€»é¢:")
print(pivot_7.round(2))
print("\n" + "-"*50 + "\n")

# 8 - æ•°æ®é€è§†ï½œç»¼åˆ - åˆ¶ä½œã€Œå„çœå¸‚ã€ã€ã€Œä¸åŒç±»åˆ«ã€äº§å“ã€Œé”€å”®é‡ä¸é”€å”®é¢ã€çš„ã€Œå‡å€¼ä¸æ€»å’Œã€çš„æ•°æ®é€è§†è¡¨ï¼Œå¹¶åœ¨æœ€åè¿½åŠ ä¸€è¡Œã€åˆè®¡ã€
print("8. æ•°æ®é€è§†ï½œç»¼åˆ - å¤æ‚é€è§†è¡¨")
print("ä»£ç : df.pivot_table(values=['æ•°é‡', 'é”€å”®é¢'], index='çœ/è‡ªæ²»åŒº', columns='ç±»åˆ«', aggfunc=['mean', 'sum'], margins=True)")

pivot_8 = df.pivot_table(values=['æ•°é‡', 'é”€å”®é¢'], 
                        index='çœ/è‡ªæ²»åŒº', 
                        columns='ç±»åˆ«', 
                        aggfunc=['mean', 'sum'], 
                        margins=True)
print("å„çœå¸‚ã€ä¸åŒç±»åˆ«äº§å“é”€å”®é‡ä¸é”€å”®é¢çš„å‡å€¼ä¸æ€»å’Œ:")
print(pivot_8.round(2))
print("\n" + "-"*50 + "\n")

# 9 - æ•°æ®é€è§†ï½œç­›é€‰ - åœ¨ä¸Šä¸€é¢˜çš„åŸºç¡€ä¸Šï¼ŒæŸ¥è¯¢ã€Œç±»åˆ«ã€ç­‰äºã€ŒåŠå…¬ç”¨å“ã€çš„è¯¦æƒ…
print("9. æ•°æ®é€è§†ï½œç­›é€‰ - æŸ¥è¯¢åŠå…¬ç”¨å“ç±»åˆ«")
print("ä»£ç : pivot_8.loc[:, (slice(None), 'åŠå…¬ç”¨å“')]")

try:
    # ç­›é€‰åŠå…¬ç”¨å“ç±»åˆ«çš„æ•°æ®
    office_supplies = pivot_8.loc[:, (slice(None), 'åŠå…¬ç”¨å“')]
    print("åŠå…¬ç”¨å“ç±»åˆ«è¯¦æƒ…:")
    print(office_supplies.round(2))
except KeyError:
    print("æ³¨æ„ï¼šåˆ—åå¯èƒ½ä¸å®Œå…¨åŒ¹é…ï¼Œè®©æˆ‘ä»¬æŸ¥çœ‹å®é™…çš„åˆ—å")
    print("å®é™…åˆ—å:", pivot_8.columns.tolist())
    # å°è¯•å…¶ä»–å¯èƒ½çš„åˆ—å
    for col in pivot_8.columns:
        if 'åŠå…¬ç”¨å“' in str(col):
            print(f"æ‰¾åˆ°åŒ¹é…åˆ—: {col}")
print("\n" + "-"*50 + "\n")

# 10 - æ•°æ®é€è§†ï½œé€†é€è§† - å°†ç¬¬5é¢˜çš„é€è§†è¡¨è¿›è¡Œé€†é€è§†
print("10. æ•°æ®é€è§†ï½œé€†é€è§† - å°†å®½è¡¨è½¬æ¢ä¸ºé•¿è¡¨")
print("ä»£ç : pivot_5.reset_index().melt(id_vars='çœ/è‡ªæ²»åŒº', var_name='æŒ‡æ ‡', value_name='æ•°å€¼')")

# é‡æ–°åˆ›å»ºç¬¬5é¢˜çš„é€è§†è¡¨ç”¨äºé€†é€è§†
pivot_5_for_melt = df.pivot_table(values=['é”€å”®é¢', 'åˆ©æ¶¦'], index='çœ/è‡ªæ²»åŒº', aggfunc='sum')
pivot_5_reset = pivot_5_for_melt.reset_index()

# è¿›è¡Œé€†é€è§†
melted_data = pivot_5_reset.melt(id_vars='çœ/è‡ªæ²»åŒº', var_name='æŒ‡æ ‡', value_name='æ•°å€¼')
print("é€†é€è§†ç»“æœ:")
print(melted_data.head(10))
print(f"é€†é€è§†åæ•°æ®å½¢çŠ¶: {melted_data.shape}")
print("\n" + "-"*50 + "\n")

# é¢å¤–åˆ†æï¼šæ•°æ®åˆå¹¶ç¤ºä¾‹
print("=== æ•°æ®åˆå¹¶ç¤ºä¾‹ ===")

# åˆ›å»ºç¤ºä¾‹æ•°æ®ç”¨äºåˆå¹¶æ¼”ç¤º
print("åˆ›å»ºç¤ºä¾‹æ•°æ®è¿›è¡Œåˆå¹¶æ¼”ç¤º:")

# æ•°æ®1ï¼šçœä»½ä¿¡æ¯
province_info = pd.DataFrame({
    'çœ/è‡ªæ²»åŒº': ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿ä¸œ', 'æ±Ÿè‹', 'æµ™æ±Ÿ'],
    'åœ°åŒº': ['ååŒ—', 'åä¸œ', 'åå—', 'åä¸œ', 'åä¸œ'],
    'ç»æµæ°´å¹³': ['å‘è¾¾', 'å‘è¾¾', 'å‘è¾¾', 'å‘è¾¾', 'å‘è¾¾']
})

# æ•°æ®2ï¼šä»åŸæ•°æ®ä¸­æå–çš„çœä»½é”€å”®æ±‡æ€»
province_sales = df.groupby('çœ/è‡ªæ²»åŒº').agg({
    'é”€å”®é¢': 'sum',
    'åˆ©æ¶¦': 'sum',
    'æ•°é‡': 'sum'
}).reset_index()

print("\nçœä»½ä¿¡æ¯è¡¨:")
print(province_info)
print("\nçœä»½é”€å”®æ±‡æ€»è¡¨:")
print(province_sales.head())

# ä½¿ç”¨mergeè¿›è¡Œåˆå¹¶
print("\nä½¿ç”¨mergeè¿›è¡Œå†…è¿æ¥:")
merged_data = pd.merge(province_info, province_sales, on='çœ/è‡ªæ²»åŒº', how='inner')
print(merged_data)

print("\nä½¿ç”¨concatè¿›è¡Œå‚ç›´åˆå¹¶ç¤ºä¾‹:")
# åˆ›å»ºä¸¤ä¸ªç›¸åŒç»“æ„çš„æ•°æ®æ¡†
df1 = df[df['çœ/è‡ªæ²»åŒº'] == 'åŒ—äº¬'].head(3)
df2 = df[df['çœ/è‡ªæ²»åŒº'] == 'ä¸Šæµ·'].head(3)

concat_result = pd.concat([df1, df2], ignore_index=True)
print("åˆå¹¶åçš„æ•°æ®:")
print(concat_result[['çœ/è‡ªæ²»åŒº', 'ç±»åˆ«', 'é”€å”®é¢', 'åˆ©æ¶¦']])

print("\n" + "="*60)
print("ğŸ‰ æ‰€æœ‰ç»ƒä¹ é¢˜ç­”æ¡ˆå·²å®Œæˆï¼")
print("\nğŸ“Š ä¸»è¦çŸ¥è¯†ç‚¹æ€»ç»“:")
print("1. pivot_table() - æ•°æ®é€è§†è¡¨åˆ›å»º")
print("2. aggfuncå‚æ•° - èšåˆå‡½æ•°è®¾ç½®ï¼ˆsum, mean, countç­‰ï¼‰")
print("3. indexå’Œcolumns - è¡Œç´¢å¼•å’Œåˆ—ç´¢å¼•è®¾ç½®")
print("4. valueså‚æ•° - è¦èšåˆçš„æ•°å€¼åˆ—")
print("5. marginså‚æ•° - æ·»åŠ åˆè®¡è¡Œ/åˆ—")
print("6. melt() - é€†é€è§†ï¼Œå®½è¡¨è½¬é•¿è¡¨")
print("7. merge() - æ•°æ®åˆå¹¶")
print("8. concat() - æ•°æ®è¿æ¥")
print("="*60)
