# 风控测试情况报告

结论：只要**某个关键维度与官方/合规客户端不一致**，就会被判为异常，从而触发风控并对**来源 IP 施加短期阻断**。
 因此，**唯一要做的**是：构建“官方基线指纹”。

------

## 一、测试情况

- **仅下单接口**触发风控，响应为**空包**或无业务体；
- 随后**同一 IP 对其他接口也不可访问**（疑似降级或黑名单/灰度封禁）；
- 其他接口在未调用下单时工作正常。

------

## 二、可能聚焦的指纹要素（还未严格测试）

> 不提供任何规避性技巧，仅列出需“对齐”的观察维度，后续在合规前提下做比对与收敛。

1. **传输与协议层**：
   - TLS 指纹（JA3/JA4）、ALPN、SNI、Cipher Suite 顺序；
   - HTTP/2 设定（SETTINGS、流量窗口、首帧顺序）。
2. **请求头与顺序**：
   - Header 白名单/顺序/大小写/是否带禁用头；
   - Accept/Accept-Language、Content-Type、Origin/Referer 一致性；
   - User-Agent/平台内核版本与官方一致性。
3. **状态与时序**：
   - Cookie/Session/设备 ID（did）、csrf/anti-replay Nonce 是否**先获取后使用**、是否过期；
   - Token 刷新节奏、下单前置接口调用**序列（state machine）**是否完整（如“预检→风控挑战→确认→下单”）；
   - 时间戳/签名的**时钟偏差**（NTP 漂移导致验签失败）。
4. **载荷与签名**：
   - 请求体字段、排序、浮点精度、JSON 序列化细节（是否去掉尾随零、编码）
   - HMAC/签名口径与盐值版本、签名参与字段一致性。
5. **网络来源画像**：
   - IP 质量（数据中心/住宅、ASN、历史失败率）、端口复用、NAT 出口共享带来的关联。

------

## 三、自动化测试思路

### Step 1：构建官方基线（Baseline）

- 使用**官方小程序/官方 SDK**在允许的调试环境中完成一次**成功下单**（或到最后一步的“确认”阶段）。
- 记录以下基线数据（仅采集你方合法可见的数据，不做反编译/破解/抓密）：
  1. **出站网络信息**：出口 IP/ASN、TLS 协商概要、HTTP/2 初始帧；
  2. **完整调用序列**：从进入下单流程的**每一个接口路径与顺序**、间隔时间、重定向/挑战（如 3xx/4xx 指引）是否出现；
  3. **请求/响应对**：头部顺序、关键头字段值、Cookie 演进；
  4. **业务签名面**：请求体字段的顺序、时间戳精度（ms/s）、小数点精度、枚举取值；
  5. **时钟对齐**：记录请求与服务器响应的时间差，确保本地与 NTP 同步。

> 基线产物：一份“成功链路的可观测快照”（含接口序列、头/体模板、时序窗口、合法出口参数）。

### Step 2：差异比对（你的请求 vs 基线）

- 对**触发风控的下单请求**逐项与基线比：
  - **Header 层**：是否多了调试头、顺序不同、大小写不一致；
  - **Cookie/Token**：是否跳过了中间态（比如缺一次“风控挑战”后的新 Cookie）；
  - **签名口径**：字段遗漏/顺序错位/时间戳单位错误（常见 ms↔s 混淆）；
  - **载荷细节**：金额/数量精度与官方 UI 行为不符；
  - **时序**：是否批量/过快触发（官方也许要求“可人类化”的间隔）。
- 记录每一处差异，并按“疑似权重”排序（签名与状态机 > 头部与时序 > 传输细节）。

### Step 3：收敛与验证（只做对齐，不做规避）

- 先修复**状态机**：严格按基线调用顺序命中所有前置接口（预检、风控挑战票据、库存校验、确认单等），在**有效期窗口**内完成下单；
- 再修复**签名与时间**：确保本地时钟与 NTP 同步（偏差 < 200ms），签名字段、排序、编码方式与基线相同；
- 然后统一**请求头与序列化**：
  - 与官方一致的 UA、Accept-Language、Content-Type、序列化规则（例如 JSON 不要自动格式化、不要额外空格）；
  - 严格遵循 Header **顺序与大小写**（部分网关确有顺序敏感的规则）。
- 最后校正**传输画像**：
  - 使用**稳定、信誉良好、与你业务主体相符的固定出口**（企业办公/云原生出口白名单），避免频繁切换或共享高风险 NAT；
  - 保持 HTTP/2/TLS 默认栈，不做“非常规优化”（自定义 Cipher 排序等）。

> 每次只改一个差异点，**灰度 5% 请求量**验证，观察是否仍触发风控与是否出现“空包”。

### Step 4：冷却与恢复流程（针对已被临时阻断的 IP）

- 一旦出现“空包+同 IP 全阻”的状态，**立即暂停**该出口的下单流量，切回**合规基线流量**（非下单链路）进行健康探测；
- 依据实际观测，常见平台会在**若干分钟到数小时**内自动解封；
- 恢复后仅放量**通过“指纹一致性验证”的版本**。

> 注：此处仅是“冷却+恢复”管理，并非通过更换 IP 进行规避。